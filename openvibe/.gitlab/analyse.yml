---

sonarqube:
  stage: analyze
  tags: ['linux']
  when: always
  dependencies: [test-extras_linux, test-sdk_linux, build_openvibe_linux] # Fetch artifacts from `test and build`
  rules:
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event")
  variables:
    GIT_STRATEGY: none
    GIT_DEPTH: "0"
  script:
    - source ${CI_PROJECT_DIR}/.gitlab/analysis.sh
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    expire_in: 24h
    paths:
      - sonar.log
      - sonar-project.properties
      - coverage.xml
      - build/compile_commands.json
      - build/analyzer_reports
      - build/build.log
      - meta-build-linux.log
#    reports:
#      junit: test.xml
#      coverage_report:
#        coverage_format: cobertura
#        path: coverage.xml
    when: always
  allow_failure: true

